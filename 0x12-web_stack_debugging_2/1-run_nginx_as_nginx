#!/usr/bin/env bash

if ! id -u nginx > /dev/null 2>&1; then
  adduser --system --group --no-create-home --disabled-password nginx
fi

# Step 2: Update the Nginx configuration to listen on port 8080
NGINX_CONF="/etc/nginx/nginx.conf"
cp "$NGINX_CONF" "$NGINX_CONF.bak" # Backup the original config file

# Modify the worker process user to 'nginx'
sed -i 's/user www-data;/user nginx;/' "$NGINX_CONF"

# Ensure Nginx listens on port 8080
if ! grep -q "listen 8080;" "$NGINX_CONF"; then
  sed -i '/server {/a\    listen 8080;' "$NGINX_CONF"
fi

# Step 3: Restart Nginx to apply changes
service nginx stop > /dev/null 2>&1 || true
chown -R nginx:nginx /var/lib/nginx /var/cache/nginx /var/log/nginx /var/run/nginx.pid 2>/dev/null || true
service nginx start

# Step 4: Verify the changes
echo "Nginx should now be running as the nginx user and listening on port 8080."
